---
export const prerender = true;

import { group } from 'radash';
import Layout from '../layouts/Layout.astro';

import ArticleList from '../components/articles/ArticleList';
import GoTop from '../components/elements/GoTop';

import {
  contentfulClient,
  KeycapArticleContentfulInterface,
  KeycapArticleType,
  ProfileContentfulInterface
} from '../lib/contentful';

import { NavigationLayoutEnum } from '../types/enum';

import type { ApiOgImage } from './api/og.png';

const articlesEntries =
  await contentfulClient.getEntries<KeycapArticleContentfulInterface>({
    content_type: 'article'
  });

const navigationLinksEntries =
  await contentfulClient.getEntries<ProfileContentfulInterface>({
    content_type: 'keycaps-profile',
    order: 'fields.title'
  });

const navigationLinks: Array<ProfileContentfulInterface> =
  navigationLinksEntries.items.map((n) => {
    const { title, slug, abbreviation } = n.fields;
    return { title, slug, abbreviation };
  });

const articles: Array<KeycapArticleType> = articlesEntries.items.map((e) => {
  const {
    img,
    title,
    profile,
    description,
    material,
    status,
    startDate,
    endDate,
    url,
    additionalUrl,
    warningText,
    isNew
  } = e.fields;

  return {
    img: img.fields.file.url,
    title,
    profile: profile.fields.title,
    profileId: profile.fields.slug,
    description,
    material,
    status,
    startDate: startDate
      ? new Date(startDate).toLocaleDateString('fr-FR')
      : undefined,
    endDate: endDate
      ? new Date(endDate).toLocaleDateString('fr-FR')
      : undefined,
    url,
    additionalUrl,
    warningText,
    isNew
  };
});

const articlesByProfile = group(articles, (a) => a.profile);
---

<Layout
  layout={NavigationLayoutEnum.MAIN}
  navigationLinks={navigationLinks}
  title="Azerty Keycaps - Annuaire de keycaps franÃ§aises"
>
  <ArticleList
    slot="main"
    articles={articlesByProfile}
    navigationLinks={navigationLinks}
    client:load
  />
  <GoTop slot="goto" client:load />
</Layout>
