---
import { Image } from '@astrojs/image/components';
import { group } from 'radash';

import Layout from '../layouts/Layout.astro';

import {
  contentfulClient,
  KeycapArticleContentfulInterface,
  KeycapArticleType,
  ProfileContentfulInterface
} from '../lib/contentful';

import GoTop from '../components/elements/GoTop.astro';
import WarningText from '../components/elements/WarningText.astro';
import Navigation from '../components/core/Navigation.astro';
import Article from '../components/articles/Article.astro';

const articlesEntries =
  await contentfulClient.getEntries<KeycapArticleContentfulInterface>({
    content_type: 'article'
  });

const navigationLinksEntries =
  await contentfulClient.getEntries<ProfileContentfulInterface>({
    content_type: 'keycaps-profile'
  });

const navigationLinks: Array<ProfileContentfulInterface> =
  navigationLinksEntries.items.map((n) => {
    const { title, slug, abbreviation } = n.fields;
    return { title, slug, abbreviation };
  });

const articles: Array<KeycapArticleType> = articlesEntries.items.map((e) => {
  const {
    img,
    title,
    profile,
    description,
    material,
    status,
    startDate,
    endDate,
    url,
    warning,
    isNew
  } = e.fields;

  return {
    img: img.fields.file.url,
    title,
    profile: profile.fields.title,
    profileId: profile.fields.slug,
    description,
    material,
    status,
    startDate: startDate ? new Date(startDate).toLocaleDateString() : undefined,
    endDate: endDate ? new Date(endDate).toLocaleDateString() : undefined,
    url,
    warning,
    isNew
  };
});

const articleByProfile = group(articles, (a) => a.profile);
---

<Layout navigationLinks={navigationLinks}>
  <main slot="main">
    <!-- <WarningText /> -->
    {
      Object.keys(articleByProfile).map((a) => (
        <section id={navigationLinks.find((n) => a === n.title)?.slug}>
          <h3>{a}</h3>
          <div>
            {articleByProfile[a]?.map((a) => (
              <Article article={a} />
            ))}
          </div>
        </section>
      ))
    }
    <GoTop />
  </main>
</Layout>

<style>
  main {
    @apply mx-auto max-w-7xl space-y-6 py-6 sm:px-6 lg:space-y-10 lg:px-8;
  }

  section {
    @apply mt-6;
  }

  section > div {
    @apply grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4;
  }

  h3 {
    @apply mb-4 text-lg font-semibold lg:text-2xl;
  }
</style>
